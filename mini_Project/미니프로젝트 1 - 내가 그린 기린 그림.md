
#API #javaScript #nodeJS #expressJS #백엔드 

# 미니프로젝트 진행

![](https://i.imgur.com/CzjLnx3.png)
[디자인 차수지FE]('https://github.com/olive-jam')

### 🧾 기획 : 내가 그린 그림을 문제로 내어 다른 사용자들이 맞추는 미니 캐쥬얼 게임
### 🎞️ 배포링크 : https://youtu.be/FEHbzJljdP0
### ⏱️ 개발 기간 : 23년 1월 13일 ~ 1월 20일 (8일)
#### 🛠️ 개발 스텍 : Node Js
### 📦 패키지 (pakeage.json)
		- aws-sdk : 아마존 AWS 인증 보안 관련
		- bcrypt : 비밀번호 암호화
		- cookie-parser : 쿠키 파싱 
		- cors : 프론트와 통신중 cors 문제 해결
		- dotenv : 민감정보에 대한 환경변수 설정
		- express : node express
		- express-rate-limit : 비정상적인 요청 방지 (악의적 공격)
		- express-sanitizer : XXS 위험 (오랫동안 업데이트 되지 않아 다른 방법 찾아야 함)
		- http2-express-bridge : node js에서 http2 패키지를 실행 시키기 위한 추가 패키
		- joi : 문자열 예외처리를 위한 검증 패키지
		- jsonwebtoken : JWT 토큰 인증 방식 사용 패키지
		- mkcert : SSL 인증서 발급을 위한 패키지
		- moment : 날짜 출력 방식 보조 패키지
		- multer : 이미지 처리 후 서버 전송을 위한 패키지
		- multer-s3 : multer 패키지 중 AWS S3 서버에 이미지 업로드를 위한 패키지
		- mysql2 : mySQL을 이용하기 위한 패키지
		- s3 : S3 서버사용을 위한 패키지
		- sequelize : node Js에서 ORM을 사용하기 위한 시퀄라이즈 패키지 
		- sequelize-cli : 시퀄라이즈 명령어를 통해 데이터 작업을 위한 패키지
		- swagger-autogen : swagger 패키지
		- swagger-ui-express : swagger ui 제작을 위한 패키지
### 📑 백엔드 프로젝트 구조
![400](https://i.imgur.com/xQ1FlCg.png)
### 📑ERD 구성
![](https://i.imgur.com/jwadYbJ.png)

### 🧾API 구성
 - https://docs.google.com/spreadsheets/d/1rrE9-8QeEqpbF8Klk7khSkzH3wmxrcfa2K53AArKNnU/edit#gid=0
### ⚙️ 프로젝트 백엔드 주요 기능
	1. 기본적 CRUD API 기능
	2. jwt 인증 및 사용자를 특정한 권한 관리
	3. 이미지 데이터 S3 업로드 처리
	4. SSL 보안 기능
	5. HTTP2 통신 적용

## 기능 및 트러블
1. CRUD 기능구현
- 프로젝트 시작 전 API명세서 작성으로 전달 데이터 양식 및 타입에 대한 사전 작업으로 인해
     데이터 양식으로 인한 트러블은 크게 발생하지 않음
- 사용자 정보 및 인증 / 게시글의 작성 조회 2가지 파트로 나누어 작업
- 스코프가 크지 않아 서버 구동까지 1일 소요

2.  인증 및 인가
🚒 트러블
	최초 jwt 토큰을 Cookie로 사용하려하였으나 서버에서 정상적으로 쿠키가 보내져 클라이언트 
	네트워크에서 확인이 가능했으나 쿠키가 다시 서버쪽으로 돌아오지 못하는 현상 발생 

🚑 해결 
	보안 통신(https) 환경에서만 쿠키에 대한 req, res가 가능하다는것을 알고, 헤더로 보내기로 결
	이유 : 쿠키로 계속 보내려면 프론트엔드에서 SSL 인증을 설정해야하는데 local 환경에서 작업하면서 시간적으로 보안인증까지 거친 후 상호 https 통신으로 테스트할 수 있는 시간이 현저히 부족하여 헤더로 보내는 방법으로 테스트 및 서비스 구현
---------------------------------------------------------------------------------------
🚒 트러블
	로컬 환경에터 코드 작성 후 백엔드 서버 배포 후 프론트에서 데이터를 받아 처리하는 과정 중 
	유명한 CORS 에러 발생

🚑 해결
	이미 CORS에 대한 대략적인 상황 및 대처에 대해 공부하여, cors 모듈을 설치하여, 
	origin을 프론트엔드 서버로 설정, 토큰에 대한 키값 및 데이터 처리 실행
	![](https://i.imgur.com/Q98aNMH.png)
	다만 글로만 보다가 실제로 적용하려하니 익숙하지 않은 코드작성에 이런저런 옵션들을 써보고 
	지우기를 반복함, 프로젝트가 끝나고 나서 보면 정말 간단하지만 놓치기쉬운 작업임
---------------------------------------------------------------------------------------
🚒 트러블
	상세조회 페이지 req,res 과정에서 프론트에서 현재 사용자를 특정할 수 있는 토큰을 디코드할 
	수 없는 이유 발생 ( 프론트에서는 익숙하지 않은 작업으로 인해 이해 및 작업시간 부족 )

🚑해결
 정답자가 정답을 입력한 postId를 프론트에서 보내고 백에서는 요청과 함께 들어온 token을 디코드하여 사용자 특정 후 DB에서 현재 사용자가 정답을 그 전에 맞추었는지 또는 정답을 맞추지 못하였는지 includes로 확인하여 true / false data를 프론트에 보내주기로 함
 
	 🚓 코드 트러블 
	 정답자가 데이터에 없거나 한번도 정답자가 입력되지 않은 값에서 error 발생하여 서버에러가 발생
	 입력값을 확인하니 null 타입으로 if문을 사용하여 분기처리할고 해도 바로 not defined
	 error가 발생하여 로직이 중단 됨,
	 
	 🚐 코드 해결
	 정답자가 없는 상황을 throw new Error로 보내고 catch에서 에러 데이터를 사용자 
	 false로 선언하고 프론트에 전달하여 해결
	 급하게 처리하여 hard coding 하였는데 추후에 코드 정리
![](https://i.imgur.com/0ZxbSGQ.png)
---------------------------------------------------------------------------------------
🚒 트러블
	req 요청시 프론트에서 동기처리가 되지 않아 전 사용자의 정보가 남아 현재 사용자의 토큰이 
	하나씩 밀려 작성자와 작성자의 정보가 일치하지 않아 표기시 하나씩 정보가 밀리는 현상 발생

🚑 해결
	최초 access Token의 만료시간을 10분에서 10초로 짧게 만들어 강제적으로 access를 
	재발급하게 만들어 동기처리 처럼 작동하도록 구현
	다만 해당방법은 자주 데이터의 처리를 발생시키며, 근본적인 해결책은 되지 못함
	프로젝트 완성 단계에서 해당부분은 프론트에서 동기처리하여, 다시 원상복구 함
---------------------------------------------------------------------------------------
*✈️ passport 패키지를 이용한 social login 기능을 구현하지 못해 공부하여 클론코딩에서 사용 예정*

3. S3 